#!/usr/bin/env python3

import sys
import datetime
import requests
import json
import os
import shutil
import subprocess
import uuid
from time import strftime

dic_xss = {}
dic_vuln = {}

cliente = sys.argv[1]
log = '/home/mbuogo/Documents/temp/'+cliente+'.log'
scan_id = str(uuid.uuid4())
hora = strftime("%Y-%m-%dT%H:%M:%S%Z")
headers = {'Accept' : 'application/json', 'Content-Type' : 'application/json'}
url_xss_1_1 = 'http://10.255.51.61:9200/'+cliente+'-xss-1-1/_doc?refresh'
url_xss_1_2 = 'http://10.255.51.61:9200/'+cliente+'-xss-1-2/_doc?refresh'
auth=('post', '55tcLrp81sj!zmcOQ%#R&ARI#4B0gH0i9m')

#Remove log se ele existir
if(os.path.isfile(log) == True):
	os.remove(log)

#Executa o XSStrike
print("\n[+] Executando o XSStrike")
subprocess.check_output('sudo python3 XSStrike/xsstrike.py -u '+sys.argv[2]+' --crawl --blind --params --file-log-level INFO --log-file '+log+' || true', shell=True)

with open(log) as file:
	for line in file:
		t = line.split(' ')
		if( 'VULN' in t):
			if('Vulnerable' in t):
				dic_xss['vuln_xss'] = t[8].replace('\x1b[92m','').replace('\x1b[0m\n','')
			if('Vector' in t):
				dic_xss['vuln_xss_vetor'] = t[9].replace('\n','').replace('v3dm0s','')
				#print(dic_xss)
				data = {'data': hora,
						'scan_id': scan_id,
						'vuln_xss_url': sys.argv[2],
						'vuln_xss': dic_xss['vuln_xss'],
						'vuln_xss_vetor': dic_xss['vuln_xss_vetor']
						}
				#print(data)
				r = requests.post(url_xss_1_1, headers=headers, auth=auth, data=json.dumps(data))
				print(r.text)
				print("\n")

		if('GOOD' in t):
			dic_vuln['vuln'] =  t[8]
			dic_vuln['vuln_version'] =  (t[9].replace('\n',''))
		if('Component' in t):
			dic_vuln['vuln_location'] = (t[8].replace('\n',''))
		if('Severity:' in t):
			dic_vuln['vuln_severity'] = (t[7].replace('\n',''))
		if('CVE:' in t):
			dic_vuln['vuln_cve'] = (t[7].replace('\n',''))
			data = {'data': hora,
					'scan_id': scan_id,
					'vuln': dic_vuln['vuln'],
					'vuln_version': dic_vuln['vuln_version'],
					'vuln_location': dic_vuln['vuln_location'],
					'vuln_severity': dic_vuln['vuln_severity'],
					'vuln_cve': dic_vuln['vuln_cve']
					}
			#print(data)
			r = requests.post(url_xss_1_2, headers=headers, auth=auth, data=json.dumps(data))
			print(r.text)
			print("\n")
