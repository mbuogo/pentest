#!/usr/bin/env python3

#Passar nome do blocoip e IP/CIDR

import xml.etree.ElementTree as ET
import sys
import datetime
import requests
import subprocess
import os
import shutil
import uuid
import socket
import json
import time
from time import strftime

dic = {}
dic_dns = {}
hora = strftime("%Y-%m-%dT%H:%M:%S%Z")

def nmap_run(ip):

    subprocess.check_output('sudo nmap -sSV -T5 -Pn --script=/usr/share/nmap/scripts/firewall-bypass.nse '+ip+' -oX scannmap.xml || true', shell=True)

def enumdns(ipaddr):
    try:
        data = socket.gethostbyaddr(ipaddr)
        dic_dns['serveraddress'] = data[0]
        dic_dns['serverdomain'] = data[0]
        dic_dns['serverip'] = ipaddr
        data = {'@timestamp':hora,
                'server.ip':dic_dns['serverip'],
                'server.address':dic_dns['serveraddress'],
                'server.domain':dic_dns['serverdomain']
                }
        print('>> DNS results')
        print(data)
        print('\n')
    except:
        pass

def parse_xml(xml):
    aux = ' '
    tree = ET.parse(xml)
    root = tree.getroot()
    for i in root.iter('nmaprun'):
        for j in i:
            for host in j:
                if(host.tag == 'address'):
                    if(':' not in host.attrib['addr']):
                        dic['ip'] = host.attrib['addr']
                        dic['serveraddress'] = host.attrib['addr']
                        dic['tipo'] = host.attrib['addrtype']
                        enumdns(host.attrib['addr'])
                if(host.tag == 'ports'):
                    for port in host:
                        if(port.tag == 'port'):
                            dic['porta'] = port.attrib['portid']
                            #nse_nmap(dic['porta'])
                            #if(dic['porta'] not in list_exclusion_webenum):
                            #    webenum(dic['ip'],dic['porta'])
                            dic['vul_name'] = 'Accessible port - '+dic['porta']
                            dic['protocolo'] = port.attrib['protocol']
                            for service in port:
                                if(service.tag == 'state'):
                                    dic['status'] = service.attrib['state']
                                    if(dic['status'] != 'open'):
                                        dic['status'] = 'Found port'
                                if(service.tag == 'service'):
                                    dic['name'] = service.attrib['name']
                                    try:
                                        dic['product'] = service.attrib["product"]
                                    except:
                                        dic['product'] = ""
                                    try:
                                        dic['version'] = service.attrib["version"]
                                    except:
                                        dic['version']  = ""
                            data = {'@timestamp':hora,
                                    'server.ip':dic['ip'],
                                    'server.address':dic['serveraddress'],
                                    'network.protocol':dic['name'],
                                    'server.port':dic['porta'],
                                    'service.name':dic['product'],
                                    'network.transport':dic['protocolo'],
                                    'service.state':dic['status'],
                                    'network.type':dic['tipo'],
                                    'application.version.number': dic['version']
                                    }
                            print(data)
                            print('\n')

def main():

    ip = sys.argv[1]
    nmap_run(ip)
    arquivo = 'scannmap.xml'
    parse_xml(arquivo)
    #nse_snmp(arquivo)

if __name__ == '__main__':
    main()
