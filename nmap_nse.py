#!/usr/bin/env python3

#Passar nome do blocoip e IP/CIDR

import xml.etree.ElementTree as ET
import sys
import datetime
import requests
import subprocess
import os
import shutil
import uuid
import json
from time import strftime

dic = {}
blocoip = sys.argv[1]

#Execucao do NMAP e import do XML

def nse_function(ip,port,nse_script):
    subprocess.check_output('sudo nmap -sSV -Pn -T5 -p'+port+' --script='+nse_script+' '+ip+' >>'+ip+'_'+nse_script+'.log || true', shell=True)


def main():

    print("[+] Executando o NMAP")
    
    subprocess.check_output('sudo nmap -sSV -Pn -T5 --script=/usr/share/nmap/scripts/firewall-bypass.nse '+blocoip+' -oX nmap.xml|| true', shell=True)
    tree = ET.parse('nmap.xml')
    root = tree.getroot()
    
    #Parse do XML    
    for i in root.iter('nmaprun'):
        for j in i:
            for host in j:
                if(host.tag == 'address'):
                    if(':' not in host.attrib['addr']):
                        dic['ip'] = host.attrib['addr']
                        dic['serveraddress'] = host.attrib['addr']
                        dic['tipo'] = host.attrib['addrtype']
                if(host.tag == 'ports'):
                    for port in host:
                        if(port.tag == 'port'):
                            dic['porta'] = port.attrib['portid']
                            if(dic['porta'] == '21'):
                                print('\n#### '+dic['ip'])
                                for nse in os.listdir('/usr/share/nmap/scripts'):
                                    if('ftp' in nse):
                                        print("Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'21',nse.rstrip('\n'))
                            if(dic['porta'] == '23'):
                                print('\n#### '+dic['ip'])
                                for nse in os.listdir('/usr/share/nmap/scripts'):    
                                    if('telnet' in nse):
                                        print("Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'23',nse.rstrip('\n'))
                            if(dic['porta'] == '22'):
                                print('\n#### '+dic['ip'])
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('ssh' in nse):
                                        print("Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'22',nse.rstrip('\n'))
                            if(dic['porta'] == '445'):
                                print('\n#### '+dic['ip'])
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('smb' in nse):
                                        print("Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'445',nse.rstrip('\n'))
                            if(dic['porta'] == '5060'):
                                print('\n#### '+dic['ip'])
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('sip' in nse):
                                        print("Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'5060',nse.rstrip('\n'))
                            if(dic['porta'] == '161'):
                                print('\n#### '+dic['ip'])
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('snmp' in nse):
                                        print("Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'161',nse.rstrip('\n'))
                            if(dic['porta'] == '162'):
                                print('\n#### '+dic['ip'])
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('snmp' in nse):
                                        print("Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'162',nse.rstrip('\n'))
                            if(dic['porta'] == '53'):
                                print('\n#### '+dic['ip'])
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('dns' in nse):
                                        print("Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'53',nse.rstrip('\n'))
                            if(dic['porta'] == '3306'):
                                print('\n#### '+dic['ip'])
                                for nse in os.listdir('/usr/share/nmap/scripts'): 
                                    if('mysql' in nse):
                                        print("Executando o NSE: "+nse)
                                        nse_function(dic['ip'],'3306',nse.rstrip('\n'))
if __name__ == '__main__':
    main()
